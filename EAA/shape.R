library(nimbleCarbon)
library(baorista)
library(here)
source(here('src','time2phase.R'))
source(here('src','unifdisc.R'))
diristick<-function(alpha,timeRange=c(5000,3001))
{
	n <- length(alpha)
	x <- matrix(rgamma(n, alpha), ncol = n , byrow = TRUE)
	res <- x %*% rep(1, n)
	res <-  x/as.vector(res)
	res <- cumsum(res)
	dur <- timeRange[1]-timeRange[2]
	st  <- c(timeRange[1],ceiling(timeRange[1]-res[1:(length(res)-1)]*dur))
	en  <- c(st[-1]+1,timeRange[2])
	return(data.frame(phasename=letters[1:length(alpha)],starts=st,ends=en))
}

# Scenario 1
# timeRange  <- c(5000,3001)
# BP  <- c(5000,4750,4500,4250,4000,3750,3500,3350,3300)
# logP  <- c(-0.5,-2,-1,0,-1,-0.8,-0.6,-0.2,-1.5) 
# fit  <- lm(logP~poly(BP,4))
# Pseq <- predict(fit,data.frame(BP=timeRange[1]:timeRange[2]))
# P <- (Pseq-min(Pseq)) / sum(Pseq-min(Pseq))
# P1 <- P
# plot(timeRange[1]:timeRange[2],P,type='l',xlim=timeRange)
# set.seed(123)
# phases <- diristick(alpha=rep(1,6),timeRange=c(5000,3001))
# scenario.1.200 <- sample(timeRange[1]:timeRange[2],size=200,replace=T,prob=P) |> time2phase(phases)
# scenario.1.5000 <- sample(timeRange[1]:timeRange[2],size=5000,replace=T,prob=P) |> time2phase(phases)
# scenario.1.200.pm <- createProbMat(scenario.1.200[,2:3],timeRange=c(5000,3001),resolution=100)
# scenario.1.5000.pm <- createProbMat(scenario.1.5000[,2:3],timeRange=c(5000,3001),resolution=100)

timeRange  <- c(5000,3001)
BP  <- c(5000,4750,4500,4250,4000,3750,3500,3350,3300)
logP  <- c(5,2,1,0,1,0.8,0.6,0.2,1.5) 
fit  <- lm(logP~poly(BP,3))
Pseq <- predict(fit,data.frame(BP=timeRange[1]:timeRange[2]))
P <- (Pseq-min(Pseq)) / sum(Pseq-min(Pseq))
P2 <- P
plot(timeRange[1]:timeRange[2],P,type='l',xlim=timeRange)
set.seed(1232453)
res=50
phases <- diristick(alpha=rep(2,8),timeRange=c(5000,3001))
scenario.2.50 <- sample(timeRange[1]:timeRange[2],size=50,replace=T,prob=P) |> time2phase(phases)
scenario.2.100 <- sample(timeRange[1]:timeRange[2],size=100,replace=T,prob=P) |> time2phase(phases)
scenario.2.500 <- sample(timeRange[1]:timeRange[2],size=500,replace=T,prob=P) |> time2phase(phases)
scenario.2.2000 <- sample(timeRange[1]:timeRange[2],size=2000,replace=T,prob=P) |> time2phase(phases)
scenario.2.50.pm <- createProbMat(scenario.2.50[,2:3],timeRange=c(5000,3001),resolution=res)
scenario.2.100.pm <- createProbMat(scenario.2.100[,2:3],timeRange=c(5000,3001),resolution=res)
scenario.2.500.pm <- createProbMat(scenario.2.500[,2:3],timeRange=c(5000,3001),resolution=res)
scenario.2.2000.pm <- createProbMat(scenario.2.2000[,2:3],timeRange=c(5000,3001),resolution=res)
par(mfrow=c(2,2))
plot(scenario.2.50.pm,main='50')
plot(scenario.2.100.pm,main='100')
plot(scenario.2.500.pm,main='500')
plot(scenario.2.2000.pm,main='2000')
plot(timeRange[1]:timeRange[2],P,type='l',xlim=timeRange)

print('1')
scenario.2.50.fit <- icarfit(scenario.2.50.pm,niter=4000000,nburnin=3000000,thin=100,parallel=T)
print('2')
scenario.2.100.fit <- icarfit(scenario.2.100.pm,niter=4000000,nburnin=3000000,thin=100,parallel=T)
print('3')
scenario.2.500.fit <- icarfit(scenario.2.500.pm,niter=4000000,nburnin=3000000,thin=100,parallel=T)
print('4')
scneario.2.2000.fit <- icarfit(scenario.2.2000.pm,niter=4000000,nburnin=3000000,thin=100,parallel=T)

save.image(file='eaa_shape.RData')

load('eaa_shape.RData')
par(mfrow=c(3,1),mar=c(4,4,2,1))
# plot(scenario.2.50.fit,plot.legend=F,hpd=c(0.5,0.95))
# lines(5000:3001,P2*50,col=2,lty=2)
# title('n=50')
plot(scenario.2.100.pm,type='dens')
plot(scenario.2.100.fit,plot.legend=F,hpd=c(0.5,0.95))
lines(5000:3001,P2*50,col=2,lty=2,lwd=2)
title('n=100')
plot(scenario.2.500.fit,plot.legend=F,hpd=c(0.5,0.95))
lines(5000:3001,P2*50,col=2,lty=2,lwd=2)
title('n=500')
plot(scneario.2.2000.fit,plot.legend=T,legend.arg=list(x='topright',bty='n'),hpd=c(0.5,0.95))
lines(5000:3001,P2*50,col=2,lty=2,lwd=2)
title('n=2000')

# plot(scneario.1.200.fit,plot.legend=F,ylim=c(0,0.2))
# lines(5000:3001,P1*100,col=2)

plot(scneario.1.5000.fit,plot.legend=F,ylim=c(0,0.2))
lines(5000:3001,P1*100,col=2)

# plot(scneario.2.500.fit,plot.legend=F,ylim=c(0,0.2))
# lines(5000:3001,P2*100,col=2)

plot(scneario.2.5000.fit,plot.legend=F,ylim=c(0,0.2))
lines(5000:3001,P2*100,col=2)
